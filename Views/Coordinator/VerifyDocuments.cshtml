@model List<Claim>
@{
    ViewData["Title"] = "Verify Documents";
}

<!-- Display Messages -->
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Page Header -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Verify Documents</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="window.print()">
                <i class="fas fa-print me-1"></i>Print
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshBtn">
                <i class="fas fa-sync-alt me-1"></i>Refresh
            </button>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-xl-2 col-md-4 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body py-3">
                <div class="d-flex">
                    <div class="flex-grow-1">
                        <h5 class="card-title" id="totalDocuments">0</h5>
                        <p class="card-text mb-0">Total Documents</p>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-file-alt fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body py-3">
                <div class="d-flex">
                    <div class="flex-grow-1">
                        <h5 class="card-title" id="pendingDocuments">0</h5>
                        <p class="card-text mb-0">Pending</p>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-clock fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body py-3">
                <div class="d-flex">
                    <div class="flex-grow-1">
                        <h5 class="card-title" id="verifiedThisWeek">0</h5>
                        <p class="card-text mb-0">Verified This Week</p>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-check-circle fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body py-3">
                <div class="d-flex">
                    <div class="flex-grow-1">
                        <h5 class="card-title" id="totalClaims">0</h5>
                        <p class="card-text mb-0">Total Claims</p>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-list-alt fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-4 col-md-8 mb-3">
        <div class="card bg-light">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-1">Document Verification Progress</h6>
                        <div class="progress" style="height: 8px; width: 200px;">
                            <div class="progress-bar bg-success" id="verificationProgress" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="text-end">
                        <small class="text-muted" id="progressText">0% Complete</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filters and Actions -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card coordinator-card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <h6 class="card-title mb-0">Filter by Status</h6>
                    </div>
                    <div class="col-md-9">
                        <div class="btn-group w-100" role="group">
                            @foreach (var status in ViewBag.StatusList)
                            {
                                <a href="@Url.Action("VerifyDocuments", new { status = status, claimId = ViewBag.SelectedClaimId })"
                                   class="btn @(ViewBag.StatusFilter == status ? "btn-primary" : "btn-outline-primary") position-relative">
                                    @status
                                    @if (status == "All")
                                    {
                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark">
                                            @Model.Sum(c => c.SupportingDocuments?.Count ?? 0)
                                        </span>
                                    }
                                </a>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card coordinator-card">
            <div class="card-body">
                <div class="btn-group w-100">
                    <button type="button" class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown" id="bulkActionsBtn" disabled>
                        <i class="fas fa-bolt me-1"></i>Bulk Actions
                    </button>
                    <ul class="dropdown-menu w-100">
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#globalVerifyModal"><i class="fas fa-check-double text-success me-2"></i>Verify Selected</a></li>
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#globalRejectModal"><i class="fas fa-times-circle text-danger me-2"></i>Reject Selected</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="selectAllBtn"><i class="fas fa-check-square me-2"></i>Select All</a></li>
                        <li><a class="dropdown-item" href="#" id="deselectAllBtn"><i class="fas fa-square me-2"></i>Deselect All</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Selected Items Counter -->
<div class="row mb-4" id="selectedCounter" style="display: none;">
    <div class="col-12">
        <div class="alert alert-info py-2">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="selectedCount">0</span> documents selected across <span id="selectedClaimsCount">0</span> claims
                </div>
                <div>
                    <button type="button" class="btn btn-sm btn-success me-2" data-bs-toggle="modal" data-bs-target="#globalVerifyModal">
                        <i class="fas fa-check-double me-1"></i>Verify Selected
                    </button>
                    <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#globalRejectModal">
                        <i class="fas fa-times-circle me-1"></i>Reject Selected
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@if (ViewBag.SelectedClaimId != null)
{
    var selectedClaim = Model.FirstOrDefault(c => c.ClaimID == (int)ViewBag.SelectedClaimId);
    if (selectedClaim != null)
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="card coordinator-card bg-light">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="card-title mb-1">
                                    <i class="fas fa-filter me-2"></i>Viewing documents for Claim #@selectedClaim.ClaimID
                                </h6>
                                <p class="text-muted mb-0">
                                    <strong>Lecturer:</strong> @selectedClaim.Lecturer?.Name |
                                    <strong>Amount:</strong> @selectedClaim.Amount.ToString("C") |
                                    <strong>Submitted:</strong> @selectedClaim.SubmissionDate.ToString("dd MMM yyyy") |
                                    <span class="badge @GetStatusBadgeClass(selectedClaim.Status)">@selectedClaim.Status</span>
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <a href="@Url.Action("ReviewClaim", new { id = selectedClaim.ClaimID })"
                                   class="btn btn-sm btn-outline-primary me-2">
                                    <i class="fas fa-eye me-1"></i>Review Claim
                                </a>
                                <a href="@Url.Action("VerifyDocuments")" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-times me-1"></i>Clear Filter
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
}

<!-- Documents List -->
<div class="row">
    <div class="col-12">
        <div class="card coordinator-card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-file-check me-2"></i>Documents for Verification
                    <span class="badge bg-primary ms-2">
                        @Model.Sum(c => c.SupportingDocuments?.Count ?? 0) documents across @Model.Count claims
                    </span>
                </h5>
                <div class="d-flex align-items-center">
                    <div class="input-group input-group-sm me-2" style="width: 200px;">
                        <input type="text" class="form-control" placeholder="Search documents..." id="searchInput">
                        <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoRefreshToggle" checked>
                        <label class="form-check-label small" for="autoRefreshToggle">Auto-refresh</label>
                    </div>
                </div>
            </div>
            <div class="card-body">
                @if (Model.Any(c => c.SupportingDocuments?.Any() == true))
                {
                    <div id="documentsContainer">
                        @foreach (var claim in Model.Where(c => c.SupportingDocuments?.Any() == true))
                        {
                            <div class="claim-documents-section mb-5" data-claim-id="@claim.ClaimID">
                                <!-- Claim Header -->
                                <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center">
                                            <h6 class="mb-0 me-3">
                                                <i class="fas fa-file-invoice me-2"></i>Claim #@claim.ClaimID - @claim.Lecturer?.Name
                                            </h6>
                                            <span class="badge @GetStatusBadgeClass(claim.Status) me-2">@claim.Status</span>
                                            <small class="text-muted">
                                                @claim.Amount.ToString("C") • @claim.SubmissionDate.ToString("dd MMM yyyy") •
                                                @claim.SupportingDocuments.Count documents
                                            </small>
                                        </div>
                                        <div class="mt-1">
                                            <small class="text-muted">
                                                <strong>Department:</strong> @claim.Lecturer?.Department |
                                                <strong>Hours:</strong> @claim.HoursWorked |
                                                <strong>Rate:</strong> @claim.Lecturer?.HourlyRate.ToString("C")/hr
                                            </small>
                                        </div>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <input type="hidden" name="claimId" value="@claim.ClaimID">
                                        <a href="@Url.Action("ReviewClaim", new { id = claim.ClaimID })"
                                           class="btn btn-sm btn-outline-primary me-2">
                                            <i class="fas fa-external-link-alt me-1"></i>Review Claim
                                        </a>
                                        <button type="button" class="btn btn-sm btn-success verify-claim-all"
                                                data-claim-id="@claim.ClaimID"
                                                data-doc-count="@claim.SupportingDocuments.Count">
                                            <i class="fas fa-check-circle me-1"></i>Verify All
                                        </button>
                                    </div>
                                </div>

                                <!-- Documents Grid -->
                                <div class="row">
                                    @foreach (var doc in claim.SupportingDocuments)
                                    {
                                        <div class="col-md-6 col-lg-4 mb-3 document-item" data-doc-name="@doc.FileName.ToLower()">
                                            <div class="card document-card h-100">
                                                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                                                    <small class="text-muted">
                                                        <i class="fas fa-file-@GetFileIcon(doc.FileName) me-1"></i>
                                                        @GetFileType(doc.FileName)
                                                    </small>
                                                    <div class="form-check">
                                                        <input class="form-check-input document-checkbox"
                                                               type="checkbox"
                                                               id="doc_@doc.DocumentID"
                                                               data-doc-id="@doc.DocumentID"
                                                               data-claim-id="@claim.ClaimID">
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <div class="text-center mb-3">
                                                        <i class="fas fa-file-@GetFileIcon(doc.FileName) fa-3x text-@GetFileColor(doc.FileName)"></i>
                                                    </div>
                                                    <h6 class="card-title text-truncate" title="@doc.FileName"
                                                        data-bs-toggle="tooltip" data-bs-placement="top">
                                                        @doc.FileName
                                                    </h6>
                                                    <div class="document-meta">
                                                        <small class="text-muted d-block">
                                                            <i class="fas fa-calendar me-1"></i>
                                                            Uploaded: @doc.UploadedDate.ToString("dd MMM yyyy HH:mm")
                                                        </small>
                                                        <small class="text-muted d-block">
                                                            <i class="fas fa-database me-1"></i>
                                                            Size: @GetFileSize(doc.FilePath)
                                                        </small>
                                                    </div>
                                                </div>
                                                <div class="card-footer bg-transparent">
                                                    <div class="btn-group w-100" role="group">
                                                        <a href="@Url.Action("DownloadDocument", new { documentId = doc.DocumentID })"
                                                           class="btn btn-sm btn-outline-primary"
                                                           data-bs-toggle="tooltip" title="Download Document">
                                                            <i class="fas fa-download"></i>
                                                        </a>
                                                        <button class="btn btn-sm btn-outline-success verify-doc"
                                                                type="button"
                                                                data-doc-id="@doc.DocumentID"
                                                                data-doc-name="@doc.FileName"
                                                                data-bs-toggle="tooltip" title="Verify Document">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-danger reject-doc"
                                                                type="button"
                                                                data-doc-id="@doc.DocumentID"
                                                                data-doc-name="@doc.FileName"
                                                                data-bs-toggle="tooltip" title="Reject Document">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-info preview-doc"
                                                                type="button"
                                                                data-doc-id="@doc.DocumentID"
                                                                data-doc-name="@doc.FileName"
                                                                data-bs-toggle="tooltip" title="Preview Document">
                                                            <i class="fas fa-search"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>

                                <!-- Batch Actions for this Claim -->
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="card bg-light">
                                            <div class="card-body py-2">
                                                <div class="row align-items-center">
                                                    <div class="col-md-6">
                                                        <small class="text-muted">
                                                            <span id="selectedCount_@claim.ClaimID">0</span> of @claim.SupportingDocuments.Count documents selected
                                                        </small>
                                                    </div>
                                                    <div class="col-md-6 text-end">
                                                        <div class="btn-group">
                                                            <button type="button" class="btn btn-sm btn-success batch-verify"
                                                                    data-claim-id="@claim.ClaimID">
                                                                <i class="fas fa-check-double me-1"></i>Verify Selected
                                                            </button>
                                                            <button type="button" class="btn btn-sm btn-danger batch-reject"
                                                                    data-claim-id="@claim.ClaimID">
                                                                <i class="fas fa-times-circle me-1"></i>Reject Selected
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            @if (claim != Model.Last(c => c.SupportingDocuments?.Any() == true))
                            {
                                <hr class="my-4">
                            }
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-5">
                        <i class="fas fa-file-check fa-4x text-muted mb-3"></i>
                        <h4 class="text-muted">No Documents to Verify</h4>
                        <p class="text-muted">
                            @if (ViewBag.StatusFilter != "All")
                            {
                                <text>There are no documents for claims with status "@ViewBag.StatusFilter".</text>
                            }
                            else
                            {
                                <text>All documents have been verified or there are no pending documents.</text>
                            }
                        </p>
                        <div class="d-flex justify-content-center gap-2">
                            <a href="@Url.Action("ReviewClaims")" class="btn btn-primary">
                                <i class="fas fa-list me-1"></i>Review Claims
                            </a>
                            <a href="@Url.Action("Dashboard")" class="btn btn-outline-secondary">
                                <i class="fas fa-tachometer-alt me-1"></i>Go to Dashboard
                            </a>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Document Verification Modal -->
<div class="modal fade" id="verifyDocModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle text-success me-2"></i>Verify Document
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="verifyDocForm" method="post" asp-action="VerifyDocument">
                <div class="modal-body">
                    <input type="hidden" name="documentId" id="verifyDocId">
                    <input type="hidden" name="isValid" id="verifyIsValid" value="true">
                    <div class="mb-3">
                        <label class="form-label">Document:</label>
                        <p class="form-control-plaintext fw-bold" id="verifyDocName"></p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Verification Notes (Optional):</label>
                        <textarea name="notes" class="form-control" rows="4"
                                  placeholder="Add verification notes or comments about this document..."></textarea>
                        <div class="form-text">
                            These notes will be recorded in the audit trail.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check me-1"></i>Verify Document
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Document Rejection Modal -->
<div class="modal fade" id="rejectDocModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-times-circle text-danger me-2"></i>Reject Document
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="rejectDocForm" method="post" asp-action="VerifyDocument">
                <div class="modal-body">
                    <input type="hidden" name="documentId" id="rejectDocId">
                    <input type="hidden" name="isValid" value="false">
                    <div class="mb-3">
                        <label class="form-label">Document:</label>
                        <p class="form-control-plaintext fw-bold" id="rejectDocName"></p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rejection Reason *:</label>
                        <textarea name="notes" class="form-control" rows="4" required
                                  placeholder="Explain why this document is being rejected..."></textarea>
                        <div class="form-text">
                            This reason will be shared with the lecturer and recorded in the audit trail.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-ban me-1"></i>Reject Document
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Verify All Documents Modal -->
<div class="modal fade" id="verifyAllModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-check-double text-success me-2"></i>Verify All Documents
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" asp-action="VerifyAllDocuments" id="verifyAllForm">
                <div class="modal-body">
                    <input type="hidden" name="claimId" id="verifyAllClaimId">
                    <div class="mb-3">
                        <p>You are about to verify all <strong id="verifyAllCount">0</strong> documents for this claim.</p>
                        <label class="form-label">Verification Notes (Optional):</label>
                        <textarea name="notes" class="form-control" rows="4"
                                  placeholder="Add verification notes for all documents..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Verify All Documents</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Global Verify Modal -->
<div class="modal fade" id="globalVerifyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-check-double text-success me-2"></i>Verify Selected Documents
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" asp-action="GlobalBatchVerify" id="globalVerifyForm">
                <input type="hidden" name="isValid" value="true">
                <div class="modal-body">
                    <p>You are about to verify <strong id="globalVerifyCount">0</strong> selected documents.</p>
                    <div class="mb-3">
                        <label class="form-label">Verification Notes (Optional):</label>
                        <textarea name="notes" class="form-control" rows="4"
                                  placeholder="Add verification notes for all selected documents..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Verify Selected Documents</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Global Reject Modal -->
<div class="modal fade" id="globalRejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-times-circle text-danger me-2"></i>Reject Selected Documents
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" asp-action="GlobalBatchVerify" id="globalRejectForm">
                <input type="hidden" name="isValid" value="false">
                <div class="modal-body">
                    <p>You are about to reject <strong id="globalRejectCount">0</strong> selected documents.</p>
                    <div class="mb-3">
                        <label class="form-label">Rejection Reason *:</label>
                        <textarea name="notes" class="form-control" rows="4" required
                                  placeholder="Explain why these documents are being rejected..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Reject Selected Documents</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Document Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalTitle">
                    <i class="fas fa-search me-2"></i>Document Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="previewContent">
                    <i class="fas fa-file fa-5x text-muted mb-3"></i>
                    <h5 id="previewFileName">Loading document...</h5>
                    <div class="mt-3" id="previewInfo">
                        <small class="text-muted">File type: <span id="previewFileType">-</span></small><br>
                        <small class="text-muted">File size: <span id="previewFileSize">-</span></small><br>
                        <small class="text-muted">Uploaded: <span id="previewUploadDate">-</span></small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-primary" id="previewDownloadBtn" style="display: none;">
                    <i class="fas fa-download me-1"></i>Download
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Load statistics
            loadDocumentStats();

            // Document selection handling
            function updateSelectionCounts() {
                const selectedDocs = $('.document-checkbox:checked');
                const globalCount = selectedDocs.length;
                const selectedClaims = [...new Set(selectedDocs.map(function() {
                    return $(this).data('claim-id');
                }).get())];

                $('#globalSelectedCount').text(globalCount);
                $('#selectedCount').text(globalCount);
                $('#selectedClaimsCount').text(selectedClaims.length);
                $('#globalVerifyCount').text(globalCount);
                $('#globalRejectCount').text(globalCount);

                // Update bulk actions button state
                $('#bulkActionsBtn').prop('disabled', globalCount === 0);

                // Show/hide selected counter
                if (globalCount > 0) {
                    $('#selectedCounter').show();
                } else {
                    $('#selectedCounter').hide();
                }

                // Update per-claim counts
                $('.claim-documents-section').each(function() {
                    const claimId = $(this).data('claim-id');
                    const claimCount = $(this).find('.document-checkbox:checked').length;
                    $(`#selectedCount_${claimId}`).text(claimCount);
                });
            }

            $('.document-checkbox').change(updateSelectionCounts);

            // Select all / deselect all
            $('#selectAllBtn').click(function(e) {
                e.preventDefault();
                $('.document-checkbox').prop('checked', true).trigger('change');
            });

            $('#deselectAllBtn').click(function(e) {
                e.preventDefault();
                $('.document-checkbox').prop('checked', false).trigger('change');
            });

            // Individual document verification
            $('.verify-doc').click(function() {
                const docId = $(this).data('doc-id');
                const docName = $(this).data('doc-name');

                $('#verifyDocId').val(docId);
                $('#verifyDocName').text(docName);
                $('#verifyIsValid').val('true');

                $('#verifyDocModal').modal('show');
            });

            // Individual document rejection
            $('.reject-doc').click(function() {
                const docId = $(this).data('doc-id');
                const docName = $(this).data('doc-name');

                $('#rejectDocId').val(docId);
                $('#rejectDocName').text(docName);

                $('#rejectDocModal').modal('show');
            });

            // Verify all documents for a claim
            $('.verify-claim-all').click(function() {
                const claimId = $(this).data('claim-id');
                const docCount = $(this).data('doc-count');

                $('#verifyAllClaimId').val(claimId);
                $('#verifyAllCount').text(docCount);

                $('#verifyAllModal').modal('show');
            });

            // Batch verify for specific claim
            $('.batch-verify').click(function() {
                const claimId = $(this).data('claim-id');
                const selectedDocs = $(`.document-checkbox[data-claim-id="${claimId}"]:checked`);

                if (selectedDocs.length === 0) {
                    showNotification('Please select at least one document to verify.', 'warning');
                    return;
                }

                const docIds = selectedDocs.map(function() {
                    return $(this).data('doc-id');
                }).get();

                $('#globalVerifyCount').text(selectedDocs.length);
                $('#globalVerifyForm input[name="documentIds"]').remove();

                docIds.forEach(docId => {
                    $('#globalVerifyForm').append(`<input type="hidden" name="documentIds" value="${docId}">`);
                });

                $('#globalVerifyModal').modal('show');
            });

            // Batch reject for specific claim
            $('.batch-reject').click(function() {
                const claimId = $(this).data('claim-id');
                const selectedDocs = $(`.document-checkbox[data-claim-id="${claimId}"]:checked`);

                if (selectedDocs.length === 0) {
                    showNotification('Please select at least one document to reject.', 'warning');
                    return;
                }

                const docIds = selectedDocs.map(function() {
                    return $(this).data('doc-id');
                }).get();

                $('#globalRejectCount').text(selectedDocs.length);
                $('#globalRejectForm input[name="documentIds"]').remove();

                docIds.forEach(docId => {
                    $('#globalRejectForm').append(`<input type="hidden" name="documentIds" value="${docId}">`);
                });

                $('#globalRejectModal').modal('show');
            });

            // Document preview
            $('.preview-doc').click(function() {
                const docId = $(this).data('doc-id');
                const docName = $(this).data('doc-name');

                $('#previewModalTitle').html(`<i class="fas fa-search me-2"></i>Preview: ${docName}`);
                $('#previewFileName').text(docName);
                $('#previewDownloadBtn').attr('href', `@Url.Action("DownloadDocument")?documentId=${docId}`).show();

                // Show loading state
                $('#previewContent').html(`
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5>Loading document information...</h5>
                `);

                // Fetch document details
                $.ajax({
                    url: '@Url.Action("PreviewDocument")',
                    type: 'GET',
                    data: { documentId: docId },
                    success: function(response) {
                        if (response.success) {
                            $('#previewContent').html(`
                                <i class="fas fa-file-${getFileIcon(response.fileType)} fa-5x text-${getFileColor(response.fileType)} mb-3"></i>
                                <h5>${response.documentName}</h5>
                                <div class="mt-3" id="previewInfo">
                                    <small class="text-muted">File type: ${response.fileType}</small><br>
                                    <small class="text-muted">File size: ${formatFileSize(response.fileSize)}</small><br>
                                    <small class="text-muted">Uploaded: ${response.uploadDate}</small>
                                </div>
                                <div class="mt-4">
                                    <p class="text-muted">Document preview is not available in this version.</p>
                                    <p class="text-muted small">Please download the document to view its contents.</p>
                                </div>
                            `);
                        } else {
                            $('#previewContent').html(`
                                <i class="fas fa-exclamation-triangle fa-5x text-warning mb-3"></i>
                                <h5>Unable to load document</h5>
                                <p class="text-muted">${response.message}</p>
                            `);
                        }
                    },
                    error: function() {
                        $('#previewContent').html(`
                            <i class="fas fa-exclamation-triangle fa-5x text-danger mb-3"></i>
                            <h5>Error loading document</h5>
                            <p class="text-muted">Please try again later.</p>
                        `);
                    }
                });

                $('#previewModal').modal('show');
            });

            // Search functionality
            $('#searchInput').on('input', function() {
                const searchTerm = $(this).val().toLowerCase();

                if (searchTerm === '') {
                    $('.document-item').show();
                    return;
                }

                $('.document-item').each(function() {
                    const docName = $(this).data('doc-name');
                    if (docName.includes(searchTerm)) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            });

            $('#clearSearch').click(function() {
                $('#searchInput').val('').trigger('input');
            });

            // Refresh button
            $('#refreshBtn').click(function() {
                refreshPage();
            });

            // Auto-refresh toggle
            let autoRefreshInterval;
            function setupAutoRefresh() {
                if ($('#autoRefreshToggle').is(':checked')) {
                    autoRefreshInterval = setInterval(() => {
                        loadDocumentStats();
                    }, 30000); // Refresh every 30 seconds
                } else {
                    clearInterval(autoRefreshInterval);
                }
            }

            $('#autoRefreshToggle').change(setupAutoRefresh);
            setupAutoRefresh();

            // Global batch actions
            $('#globalVerifyForm').submit(function() {
                const selectedDocs = $('.document-checkbox:checked');
                if (selectedDocs.length === 0) {
                    showNotification('Please select at least one document.', 'warning');
                    return false;
                }

                const docIds = selectedDocs.map(function() {
                    return $(this).data('doc-id');
                }).get();

                $(this).find('input[name="documentIds"]').remove();
                docIds.forEach(docId => {
                    $(this).append(`<input type="hidden" name="documentIds" value="${docId}">`);
                });

                return true;
            });

            $('#globalRejectForm').submit(function() {
                const selectedDocs = $('.document-checkbox:checked');
                if (selectedDocs.length === 0) {
                    showNotification('Please select at least one document.', 'warning');
                    return false;
                }

                const docIds = selectedDocs.map(function() {
                    return $(this).data('doc-id');
                }).get();

                $(this).find('input[name="documentIds"]').remove();
                docIds.forEach(docId => {
                    $(this).append(`<input type="hidden" name="documentIds" value="${docId}">`);
                });

                return true;
            });

            // Helper functions
            function loadDocumentStats() {
                $.ajax({
                    url: '@Url.Action("GetDocumentStats")',
                    type: 'GET',
                    data: { status: '@ViewBag.StatusFilter' },
                    success: function(response) {
                        if (response.success) {
                            const stats = response.data;
                            $('#totalDocuments').text(stats.totalDocuments);
                            $('#pendingDocuments').text(stats.pendingDocuments);
                            $('#verifiedThisWeek').text(stats.verifiedThisWeek);
                            $('#totalClaims').text(stats.totalClaims);

                            // Calculate progress
                            const progress = stats.totalDocuments > 0 ?
                                ((stats.totalDocuments - stats.pendingDocuments) / stats.totalDocuments * 100) : 0;
                            $('#verificationProgress').css('width', progress + '%');
                            $('#progressText').text(progress.toFixed(1) + '% Complete');
                        }
                    }
                });
            }

            function refreshPage() {
                const $refreshBtn = $('#refreshBtn');
                $refreshBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...');

                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }

            function showNotification(message, type) {
                const alertClass = type === 'success' ? 'alert-success' :
                                 type === 'warning' ? 'alert-warning' : 'alert-danger';
                const icon = type === 'success' ? 'fa-check-circle' :
                            type === 'warning' ? 'fa-exclamation-triangle' : 'fa-exclamation-circle';

                const notification = $(`
                    <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                        <i class="fas ${icon} me-2"></i>${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `);

                $('.container-fluid').prepend(notification);

                setTimeout(function() {
                    notification.alert('close');
                }, 5000);
            }

                    function getFileIcon(fileType) {
            const ext = fileType.toLowerCase();
            if (ext === '.pdf') return 'pdf';
            if (ext === '.doc' || ext === '.docx') return 'word';
            if (ext === '.xls' || ext === '.xlsx') return 'excel';
            if (['.jpg', '.jpeg', '.png', '.gif'].includes(ext)) return 'image';
            return 'alt';
        }

        function getFileColor(fileType) {
            const ext = fileType.toLowerCase();
            if (ext === '.pdf') return 'danger';
            if (ext === '.doc' || ext === '.docx') return 'primary';
            if (ext === '.xls' || ext === '.xlsx') return 'success';
            if (['.jpg', '.jpeg', '.png', '.gif'].includes(ext)) return 'info';
            return 'secondary';
        }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // Initialize selection counts
            updateSelectionCounts();
        });
    </script>

@functions {
    public string GetFileIcon(string fileName)
    {
        var extension = System.IO.Path.GetExtension(fileName).ToLower();
        return extension switch
        {
            ".pdf" => "pdf",
            ".doc" or ".docx" => "word",
            ".xls" or ".xlsx" => "excel",
            ".jpg" or ".jpeg" or ".png" or ".gif" => "image",
            _ => "alt"
        };
    }

    public string GetFileColor(string fileName)
    {
        var extension = System.IO.Path.GetExtension(fileName).ToLower();
        return extension switch
        {
            ".pdf" => "danger",
            ".doc" or ".docx" => "primary",
            ".xls" or ".xlsx" => "success",
            ".jpg" or ".jpeg" or ".png" or ".gif" => "info",
            _ => "secondary"
        };
    }

    public string GetFileType(string fileName)
    {
        var extension = System.IO.Path.GetExtension(fileName).ToLower();
        return extension switch
        {
            ".pdf" => "PDF Document",
            ".doc" => "Word Document",
            ".docx" => "Word Document",
            ".xls" => "Excel Spreadsheet",
            ".xlsx" => "Excel Spreadsheet",
            ".jpg" or ".jpeg" => "JPEG Image",
            ".png" => "PNG Image",
            ".gif" => "GIF Image",
            _ => "File"
        };
    }

    public string GetFileSize(string filePath)
    {
        try
        {
            var fullPath = System.IO.Path.Combine("wwwroot", "documents", filePath);
            if (System.IO.File.Exists(fullPath))
            {
                var fileInfo = new System.IO.FileInfo(fullPath);
                long bytes = fileInfo.Length;

                string[] sizes = { "B", "KB", "MB", "GB" };
                int order = 0;
                while (bytes >= 1024 && order < sizes.Length - 1)
                {
                    order++;
                    bytes = bytes / 1024;
                }
                return $"{bytes:0.##} {sizes[order]}";
            }
        }
        catch
        {
            // If there's any error, return unknown
        }
        return "Unknown";
    }

    public string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Pending" => "bg-warning",
            "Under Review" => "bg-info",
            "Coordinator Approved" => "bg-success",
            "Approved" => "bg-success",
            "Rejected" => "bg-danger",
            "Revision Requested" => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    public string GetActivityColor(string action)
    {
        return action?.ToLower() switch
        {
            var a when a.Contains("approved") => "success",
            var a when a.Contains("rejected") => "danger",
            var a when a.Contains("revision") => "warning",
            var a when a.Contains("verified") => "info",
            var a when a.Contains("submitted") => "primary",
            _ => "secondary"
        };
    }
}

<style>
    .coordinator-card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        margin-bottom: 1.5rem;
    }

        .coordinator-card .card-header {
            background: #fff;
            border-bottom: 1px solid #e3e6f0;
            font-weight: 600;
            padding: 1rem 1.35rem;
        }

        .coordinator-card .card-body {
            padding: 1.35rem;
        }

    .document-card {
        transition: transform 0.2s;
        border: 1px solid #e3e6f0;
    }

        .document-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

    .table th {
        border-top: none;
        font-weight: 600;
        color: #6e707e;
        background-color: #f8f9fc;
    }

    .table-hover tbody tr:hover {
        background-color: #f8f9fc;
    }

    /* File type colors */
    .text-pdf {
        color: #dc3545 !important;
    }

    .text-word {
        color: #0d6efd !important;
    }

    .text-excel {
        color: #198754 !important;
    }

    .text-image {
        color: #0dcaf0 !important;
    }

    .text-file {
        color: #6c757d !important;
    }
</style>
}