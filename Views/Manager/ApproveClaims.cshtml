@model List<Claim>
@{
    ViewData["Title"] = "Approve Claims";
    Layout = "_ManagerLayout";
}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom">
    <h1 class="h2">Approve Claims</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <select id="statusFilter" class="form-select form-select-sm">
                <option value="Coordinator Approved">Coordinator Approved</option>
                <option value="Pending">Pending</option>
                <option value="Approved">Approved</option>
                <option value="Rejected">Rejected</option>
                <option value="Under Review">Under Review</option>
            </select>
        </div>
    </div>
</div>

<!-- Status Summary Cards -->
<div class="row mb-4">
    <div class="col-xl-2 col-md-4 mb-3">
        <div class="card manager-card border-start border-warning border-4">
            <div class="card-body text-center">
                <div class="h4 mb-0 fw-bold text-warning">@Model.Count(c => c.Status == "Coordinator Approved")</div>
                <small class="text-muted">Awaiting Final Approval</small>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 mb-3">
        <div class="card manager-card border-start border-info border-4">
            <div class="card-body text-center">
                <div class="h4 mb-0 fw-bold text-info">@Model.Count(c => c.Status == "Under Review")</div>
                <small class="text-muted">Under Review</small>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 mb-3">
        <div class="card manager-card border-start border-success border-4">
            <div class="card-body text-center">
                <div class="h4 mb-0 fw-bold text-success">@Model.Count(c => c.Status == "Approved")</div>
                <small class="text-muted">Approved</small>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 mb-3">
        <div class="card manager-card border-start border-danger border-4">
            <div class="card-body text-center">
                <div class="h4 mb-0 fw-bold text-danger">@Model.Count(c => c.Status == "Rejected")</div>
                <small class="text-muted">Rejected</small>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 mb-3">
        <div class="card manager-card border-start border-secondary border-4">
            <div class="card-body text-center">
                <div class="h4 mb-0 fw-bold text-secondary">@Model.Count(c => c.Status == "Pending")</div>
                <small class="text-muted">Pending</small>
            </div>
        </div>
    </div>
</div>

<!-- Claims Table -->
<div class="card manager-card">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="fas fa-check-double me-2 text-warning"></i>Claims Management
        </h5>
        <div>
            <span class="badge bg-warning">@Model.Count(c => c.Status == "Coordinator Approved") Ready for Final Approval</span>
        </div>
    </div>
    <div class="card-body">
        @if (Model != null && Model.Any())
        {
            <div class="table-responsive">
                <table class="table table-hover" id="claimsTable">
                    <thead class="table-light">
                        <tr>
                            <th>Claim ID</th>
                            <th>Lecturer</th>
                            <th>Department</th>
                            <th>Hours</th>
                            <th>Amount</th>
                            <th>Submitted</th>
                            <th>Status</th>
                            <th>Coordinator</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var claim in Model)
                        {
                            <tr data-status="@claim.Status">
                                <td>
                                    <strong>#@claim.ClaimID</strong>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-sm bg-primary rounded-circle me-2 d-flex align-items-center justify-content-center">
                                            <i class="fas fa-user text-white"></i>
                                        </div>
                                        <div>
                                            <div class="fw-bold">@claim.Lecturer?.Name</div>
                                            <small class="text-muted">@claim.Lecturer?.User?.EmployeeId</small>
                                        </div>
                                    </div>
                                </td>
                                <td>@claim.Lecturer?.Department</td>
                                <td>
                                    <span class="badge bg-light text-dark">@claim.HoursWorked hrs</span>
                                </td>
                                <td>
                                    <span class="fw-bold text-success">@claim.Amount.ToString("C")</span>
                                </td>
                                <td>@claim.SubmissionDate.ToString("dd MMM yyyy")</td>
                                <td>
                                    @switch (claim.Status)
                                    {
                                        case "Coordinator Approved":
                                            <span class="badge bg-warning"><i class="fas fa-check-double me-1"></i>Ready for Final Approval</span>
                                            break;
                                        case "Approved":
                                            <span class="badge bg-success"><i class="fas fa-check me-1"></i>Approved</span>
                                            break;
                                        case "Rejected":
                                            <span class="badge bg-danger"><i class="fas fa-times me-1"></i>Rejected</span>
                                            break;
                                        case "Under Review":
                                            <span class="badge bg-info"><i class="fas fa-search me-1"></i>Under Review</span>
                                            break;
                                        default:
                                            <span class="badge bg-secondary">@claim.Status</span>
                                            break;
                                    }
                                </td>
                                <td>
                                    @{
                                        var coordinatorApproval = claim.AuditTrails?
                                            .FirstOrDefault(a => a.Action.Contains("Coordinator Approved"));
                                        if (coordinatorApproval != null)
                                        {
                                            <small>@coordinatorApproval.User?.FullName</small>
                                            <br>
                                            <small class="text-muted">@coordinatorApproval.Timestamp.ToString("dd MMM yy")</small>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">N/A</span>
                                        }
                                    }
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="@Url.Action("ClaimAnalysis", new { id = claim.ClaimID })" 
                                           class="btn btn-sm btn-outline-primary" title="Analyze Claim">
                                            <i class="fas fa-chart-line"></i>
                                        </a>
                                        
                                        @if (claim.Status == "Coordinator Approved" || claim.Status == "Under Review")
                                        {
                                            <form method="post" asp-action="FinalApproveClaim" class="d-inline">
                                                <input type="hidden" name="claimId" value="@claim.ClaimID" />
                                                <button type="submit" class="btn btn-sm btn-success" 
                                                        onclick="return confirm('Grant final approval for claim #@claim.ClaimID?')"
                                                        title="Approve Claim">
                                                    <i class="fas fa-check-double"></i>
                                                </button>
                                            </form>
                                            
                                            <button type="button" class="btn btn-sm btn-danger" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#rejectModal"
                                                    data-claim-id="@claim.ClaimID"
                                                    title="Reject Claim">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        }
                                        
                                        @if (claim.Status == "Pending")
                                        {
                                            <span class="badge bg-secondary">Awaiting Coordinator</span>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="text-center py-5">
                <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                <h4 class="text-success">No Claims Found!</h4>
                <p class="text-muted">There are no claims matching the current filter criteria.</p>
            </div>
        }
    </div>
</div>

<!-- Reject Claim Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reject Claim</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" asp-action="ManagerRejectClaim">
                <div class="modal-body">
                    <input type="hidden" name="claimId" id="rejectClaimId">
                    <div class="mb-3">
                        <label for="rejectReason" class="form-label">Rejection Reason</label>
                        <textarea class="form-control" id="rejectReason" name="reason" rows="4" 
                                  placeholder="Please provide a reason for rejecting this claim..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Reject Claim</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Status filter functionality
            $('#statusFilter').change(function() {
                const status = $(this).val();
                window.location.href = '@Url.Action("ApproveClaims")?status=' + status;
            });

            // Set current filter value
            $('#statusFilter').val('@ViewBag.CurrentStatus');

            // Reject modal setup
            $('#rejectModal').on('show.bs.modal', function(event) {
                const button = $(event.relatedTarget);
                const claimId = button.data('claim-id');
                $('#rejectClaimId').val(claimId);
            });

            // Table filtering
            $('#claimsTable').DataTable({
                pageLength: 25,
                order: [[5, 'desc']],
                language: {
                    search: "Search claims:"
                }
            });
        });
    </script>
}